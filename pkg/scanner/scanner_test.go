package scanner

import (
	"encoding/hex"
	"fmt"
	"github.com/projectdiscovery/gologger"
	"github.com/projectdiscovery/gologger/levels"
	"github.com/tongchengbin/xmap/pkg/types"
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/tongchengbin/xmap/pkg/utils"
)

func createTestScanner() *ServiceScanner {
	gologger.DefaultLogger.SetMaxLevel(levels.LevelDebug)
	opts := types.DefaultOptions()
	opts.VersionIntensity = 9
	opts.DebugResponse = true
	opts.ServiceVersion = true
	opts.Debug = true
	scan, err := NewServiceScanner(opts)
	if err != nil {
		panic(err)
	}
	fmt.Println(scan)
	return scan

}
func TestParseCertificatesFromServerHello(t *testing.T) {
	//  百度server hello
	sslHex := "160300004a02000046030045e4effa22c652f4c8c3aaa1737b1e1ab0ae482aa2d844beb6a4539ab12b62b920e3c6f0e7bc57f272492597a6d1702bc1a7f8193052a0122245d6abdb0ce27b8200050016030013070b00130300130000089b308208973082067fa00302010202100f8d6747f3a1428f79937a2e49793428300d06092a864886f70d01010b0500306b310b300906035504061302555331173015060355040a130e44696769436572742c20496e632e314330410603550403133a44696769436572742053656375726520536974652050726f20473220544c5320434e205253413430393620534841323536203230323220434131301e170d3235303231323030303030305a170d3236303330333233353935395a3073310b300906035504061302434e3112301006035504080c09e58c97e4baace5b88231393037060355040a13304265694a696e67204261696475204e6574636f6d20536369656e636520546563686e6f6c6f677920436f2e2c204c7464311530130603550403130c7777772e62616964752e636e30820122300d06092a864886f70d01010105000382010f003082010a0282010100dba0bdef4f6919650ce4b8f97ea59a48ba774a41476c5ae4de5363fda753b6ac8d0468a30cae0f473977a940a226e5cf829a7a0955f728d30ff67a9246f09a3fc6e5c90c76f675b764c7f73aabb2f0f8b070898dd09f261166db31783b2537edb9e1ec9d14a63723ce421657a66aa58cbaf05341871603cd4c04080047cd1f3fc7d186f247d2db2d0d0d3ea9bbe2b2feff972ca6cb8fa397585760b2d44a5e027a1b47f1a4f871c878ec2d62d5a5731f4ee19ad08bc3b8101a594a4ec8ea7abf67e99cd28ff5501f2e924c26c8016fb41599812c71dd02efa2cf67c42ea6f6ed8964ca087f3a53078e634456521ff62f5e8268a15c929cfee0180046db2956d50203010001a382042d30820429301f0603551d23041830168014e16cc394856fe7412f557a337d8f5fb620503615301d0603551d0e0416041451a24da29bab92d6a93eb41a321da38d275e16293081f40603551d110481ec3081e9820c7777772e62616964752e636e820862616964752e636e820962616964752e636f6d820c62616964752e636f6d2e636e820b772e62616964752e636f6d820c77772e62616964752e636f6d82107777772e62616964752e636f6d2e636e82107777772e62616964752e636f6d2e686b820c7777772e62616964752e686b82107777772e62616964752e6e65742e617582107777772e62616964752e6e65742e706882107777772e62616964752e6e65742e747782107777772e62616964752e6e65742e766e820e777777772e62616964752e636f6d8211777777772e62616964752e636f6d2e636e303e0603551d20043730353033060667810c0102023029302706082b06010505070201161b687474703a2f2f7777772e64696769636572742e636f6d2f435053300e0603551d0f0101ff0404030205a0301d0603551d250416301406082b0601050507030106082b06010505070302305c0603551d1f045530533051a04fa04d864b687474703a2f2f63726c2e64696769636572742e636e2f44696769436572745365637572655369746550726f4732544c53434e52534134303936534841323536323032324341312e63726c30819206082b06010505070101048185308182302306082b060105050730018617687474703a2f2f6f6373702e64696769636572742e636e305b06082b06010505073002864f687474703a2f2f636163657274732e64696769636572742e636e2f44696769436572745365637572655369746550726f4732544c53434e52534134303936534841323536323032324341312e637274300c0603551d130101ff040230003082017e060a2b06010401d6790204020482016e0482016a01680076000e5794bcf3aea93e331b2c9907b3f790df9bc23d713225dd21a925ac61c54e2100000194f917cce3000004030047304502204126308ab28f80e9dfa8d0c3119d612962ae5d311d83b89a3a98993e1c3205bc022100cb73d48c764889457b0dd63da862d589c7e4b8598dc7cc981b56c5679eabc16d0076006411c46ca412eca7891ca2022e00bcab4f2807d41e3527abeafed503c97dcdf000000194f917cd20000004030047304502207a16680b205295fa7e0ea24e99ee7830791114a49851563410f1de07bacb3d39022100cf878a14fc2e27ed68f91b35468b90e3bc16428c48e0052f5162f364f9ddf11a007600499c9b69de1d7cecfc36decd8764a6b85baf0a878019d15552fbe9eb29ddf8c300000194f917cd39000004030047304502205fd058fdf9549598922fae355e49afc9a6972bc39d8fbea58e41a4521fd3a7ac0221009bd27fcb9356bb79c0957d9c22d734cf6533b2b389e01e752a6dd59fe6f2ea84300d06092a864886f70d01010b0500038202010066b249ebe97013ca21240bdfa5e95775ace22866e367c9551781235ee0521e23146057bc8a36e6b6cbde2e4070790a46c2876348ba93397dfb40281772793956d5ea822ec3555d3c5c691fc2f8d0c522c469f7cafb233bf87c571a6b91d073ce86143e32308dec05e6b604fd1c7949c45d250c3ebe6f33bfba5558b6bc1ae00c7453c727ebf19cecbd8badc8bd3896c405b08209db596e02f55122903d50c8f8dd8dca30e2ec4278eca2271198b6dfd455a6e4cff2925f8eb3b216c2a6da20b8c9afd76480350561389f45c55d7a1c62adbda569fbed4e6ea948166f7dd025003bd5b5d3ce0e8a54d8078f6e1b663aa237c6a36dcee6ed3c56261ffb40ed1399c2dac0b195e1dbe720768e43039a0ad73142bafd57401743bc039dc46c990cd238a95c664a7d579c08f8df8e16f06a4b5b7a967391a64bbe529768cfcd47228eaa8722c2e03ca53dbdf3df22d9670152c441464b67554359c091febcef61776a3477d21765cacd8d013be4a0675e863dfef9ac394241af198d071a1b8979a570dd1ea7d4a1b0b4957c4e165ad4b8bed56d0f7175fb3372d3db4568d67117218aeffed9bff4eaf4886701b396f1ee9b5fdfaf48f3cdbd4d1fbfb4ae2a5d612669af96e41f9e4589857e4df496bf3937897c7e407407efd722ab98bb96cf0821dd92373709eabfd2a8dd37ba48f7a0e502d18debfb085cedfdbc1f98cafee7ffd20005da308205d6308204bea00302010202100fc9fffd217e9f57f5ea1e2d80d92050300d06092a864886f70d01010b05003061310b300906035504061302555331153013060355040a130c446967694365727420496e6331193017060355040b13107777772e64696769636572742e636f6d3120301e06035504031317446967694365727420476c6f62616c20526f6f74204732301e170d3232313231353030303030305a170d3332313231343233353935395a306b310b300906035504061302555331173015060355040a130e44696769436572742c20496e632e314330410603550403133a44696769436572742053656375726520536974652050726f20473220544c5320434e20525341343039362053484132353620323032322043413130820222300d06092a864886f70d01010105000382020f003082020a0282020100b4f5ee107413173cf6d81cb10ceb9acac25c0e6eea56e6c3cbde95cc5da66e3c4a09a0df320392ec634f91a6a3c634ba9292ac307009b04f4184cb49d689274be519b2de0296dc8c623b74114355c68fa08a34104e1a4757910074f6d4cca66f4b4cbebc3bb62b6213e2ec8abc407d8f7b615f4aa7d3adfc38d0d6d69f4efc461a8904ab5ef7048fa7ed7f91032ea91c0d473ca90a660856ba5916b9f7b7b660d6f2524713a6311d3b899dcde12439d986afd3b7af73a420b7ce1081da4a3cd2d9a78313f677fc555123f60ceb7ef9cee659e273d4e217608febe0960e720dbed1f5b321bb6c3f5f63c3960a0d3fb3a61788934593a10285af240238b58acc80e34c3756f178834cc68054ea20eb1f0b00e41347f2c3563d456817563ead756a20a8f266da2e9c5ae3458918c7f4fff56a1907609d48a81edd3a7a9068e5f7265c4e5b2946bc2ce2bb1e48133dcfe8cc6fa56becf6008d7ca7c31f7c861e2c2c6e06c7f05ffb85b3b872050409070292d4ddaaefc77bca73947d154304dc7859030e0d7aff5789574720bcccd78d09697ed1c1848d57953e760be00dca8e78d741e0eed94534c95e29eb27ce1339d45cd87e688a002a4d978634f11d9e6568696df4052323a5d4c4ea27b33ca15cab542d1782e7f76ff2aa17ed26022b3d3da62ccaaa6812f2f4d27467a11f4e7f23f35940896ad650f361da04aa30b9d34cb90203010001a382017e3082017a30120603551d130101ff040830060101ff020100301d0603551d0e04160414e16cc394856fe7412f557a337d8f5fb620503615301f0603551d230418301680144e2254201895e6e36ee60ffafab912ed06178f39300e0603551d0f0101ff040403020186301d0603551d250416301406082b0601050507030106082b06010505070302307406082b0601050507010104683066302306082b060105050730018617687474703a2f2f6f6373702e64696769636572742e636e303f06082b060105050730028633687474703a2f2f636163657274732e64696769636572742e636e2f4469676943657274476c6f62616c526f6f7447322e63727430400603551d1f043930373035a033a031862f687474703a2f2f63726c2e64696769636572742e636e2f4469676943657274476c6f62616c526f6f7447322e63726c303d0603551d2004363034300b06096086480186fd6c02013007060567810c01013008060667810c0102013008060667810c0102023008060667810c010203300d06092a864886f70d01010b0500038201010092777340f834ffd561907c2d63e9b625f9c30c362dca82e554e243b8e51fb574e1f90da58eb6866ce9988e3d56cd71e63c049386dc1222cb58b33fbf3c5e0f50d6b5f4ef3b9dfed3f36ce95ea646447994f1c6289013b20f3d080fd004964084ac5fa5e2d660b3ebb6ea371f56ed7337d08b5c4d7987ec5478be442fff4dda241e1c836e274ac9362220ad5efe03e073dac9dd77e2f0d3c359b63db724df494fc6e41c3a7cf6d83e4cfb28d9b2af9a7577a050bfb10f420930b87707df183a27665b1e3a60b7ac59b8bd6a4cf709337ef02ee8ef7185fd6d47033d95d823b2a204596a9e2dd2a2495f69e0b7e6ac060088fdeb1b4263e7397c1e30fde78aa7960004823082047e30820366a00302010202100fe032ab844d033106c50c8e13c8b068300d06092a864886f70d01010b05003061310b300906035504061302555331153013060355040a130c446967694365727420496e6331193017060355040b13107777772e64696769636572742e636f6d3120301e06035504031317446967694365727420476c6f62616c20526f6f74204341301e170d3234303131383030303030305a170d3331313130393233353935395a3061310b300906035504061302555331153013060355040a130c446967694365727420496e6331193017060355040b13107777772e64696769636572742e636f6d3120301e06035504031317446967694365727420476c6f62616c20526f6f7420473230820122300d06092a864886f70d0101010500"
	data, _ := hex.DecodeString(sslHex)
	cert, err := utils.ParseCertificatesFromServerHello(data)
	assert.Nil(t, err, "证书解析错误")
	fmt.Printf("%v", cert)
}

func TestDialerGetTls(t *testing.T) {
	//	todo dialer 目前使用的是hostname 作为key、应该使用host 作为key才能保证数据准确性
}
